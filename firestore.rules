rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    function noPreciseLocation(data) {
      return !("lat" in data || "lng" in data || "latitude" in data || "longitude" in data || "coords" in data || "location" in data || "address" in data);
    }

    function signalKeysOk(data) {
      return data.keys().hasOnly(["created_at", "source_type", "category", "grid_id", "status", "weight", "expireAt"]);
    }

    function resourceKeysOk(data) {
      return data.keys().hasOnly(["resource_id", "resource_type", "availability_state", "updated_at", "capacity_score"]);
    }

    function logKeysOk(data) {
      return data.keys().hasOnly(["created_at", "grid_id", "action", "outcome", "org_id", "mode"]);
    }

    match /signals/{signalId} {
      allow read: if false;
      allow create: if request.auth != null
        && noPreciseLocation(request.resource.data)
        && signalKeysOk(request.resource.data)
        && request.resource.data.grid_id is string
        && request.resource.data.category is string
        && request.resource.data.source_type in ["public", "provider", "org"]
        && request.resource.data.status == "open";
      allow update, delete: if false;
    }

    match /resources/{resourceId} {
      allow read: if true;
      allow create, update: if request.auth != null
        && noPreciseLocation(request.resource.data)
        && resourceKeysOk(request.resource.data)
        && request.resource.data.resource_id is string
        && request.resource.data.resource_type is string
        && request.resource.data.availability_state is string
        && request.resource.data.capacity_score is number;
      allow delete: if false;
    }

    match /outreachLogs/{logId} {
      allow read: if false;
      allow create: if request.auth != null
        && noPreciseLocation(request.resource.data)
        && logKeysOk(request.resource.data)
        && request.resource.data.grid_id is string
        && request.resource.data.action is string
        && request.resource.data.outcome is string;
      allow update, delete: if false;
    }

    match /gridAgg/{gridId} {
      allow read: if true;
      allow write: if false;
    }

    match /meta/{docId} {
      allow read: if true;
      allow write: if false;
    }
  }
}
